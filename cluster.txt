const cluster = require("cluster");
const http = require("http");
const os = require("os");

const numCPUs = os.cpus().length;

if (cluster.isPrimary) {
    console.log(`Master ${process.pid} is running`);

    for (let i = 0; i < numCPUs; i++) {
        cluster.fork();
    }

    cluster.on("exit", (worker) => {
        console.log(`Worker ${worker.process.pid} died`);
        cluster.fork(); // restart worker
    });

} else {
    http.createServer((req, res) => {
        res.end(`Handled by worker ${process.pid}`);
    }).listen(3000);

    console.log(`Worker ${process.pid} started`);
}




Cluster Module in Node.js ‚Äì Interview Prep
1Ô∏è‚É£ What is the Cluster Module ?
    Definition(Interview - ready ‚≠ê)

The Cluster module allows Node.js to create multiple child processes(workers) that share the same server port, enabling full utilization of multi - core CPUs.

üëâ It helps overcome Node.js‚Äôs single - threaded limitation.

2Ô∏è‚É£ Why Do We Need Cluster ?
    Problem

Node.js runs on one main thread

On a multi - core CPU, only one core is used

Solution

Cluster forks multiple worker processes

Each worker runs its own event loop

All workers share the same port

3Ô∏è‚É£ How Cluster Works(VERY IMPORTANT ‚≠ê)

Master(Primary) process starts

Master forks worker processes

Workers handle incoming requests

OS distributes load between workers(round - robin)

4Ô∏è‚É£ Basic Cluster Example
const cluster = require("cluster");
const http = require("http");
const os = require("os");

const numCPUs = os.cpus().length;

if (cluster.isPrimary) {
    console.log(`Master ${process.pid} is running`);

    for (let i = 0; i < numCPUs; i++) {
        cluster.fork();
    }

    cluster.on("exit", (worker) => {
        console.log(`Worker ${worker.process.pid} died`);
        cluster.fork(); // restart worker
    });

} else {
    http.createServer((req, res) => {
        res.end(`Handled by worker ${process.pid}`);
    }).listen(3000);

    console.log(`Worker ${process.pid} started`);
}

5Ô∏è‚É£ Master vs Worker Process
Master(Primary)	Worker
Forks workers	Handles requests
No business logic	Runs app code
Manages workers	Independent event loop
6Ô∏è‚É£ Is Cluster Multithreading ? (TRICK QUESTION ‚≠ê)

‚ùå No
‚úîÔ∏è It is multi - process

Each worker = separate process

Separate memory

Communicate via IPC

7Ô∏è‚É£ Load Balancing in Cluster

Node.js uses round - robin scheduling

OS decides which worker gets request

Can be disabled on Windows

cluster.schedulingPolicy = cluster.SCHED_RR;

8Ô∏è‚É£ Shared State Problem(VERY IMPORTANT ‚ö†Ô∏è)

‚ùå Workers do NOT share memory

let count = 0; // each worker has its own copy

Solutions

‚úîÔ∏è Redis
‚úîÔ∏è Database
‚úîÔ∏è Message passing
‚úîÔ∏è Shared external cache

9Ô∏è‚É£ Communication Between Master & Workers
Send message from worker
process.send({ msg: "hello master" });

Receive in master
cluster.on("message", (worker, message) => {
    console.log(message);
});

üîü Cluster Events(Often Asked)
Event	Description
fork	Worker created
online	Worker online
listening	Worker bound to port
exit	Worker exited
1Ô∏è‚É£1Ô∏è‚É£ Cluster vs Worker Threads(VERY COMMON ‚≠ê)
Cluster	Worker Threads
Multi - process	Multi - thread
Separate memory	Shared memory
Best for HTTP servers	CPU - intensive tasks
IPC communication	SharedArrayBuffer
1Ô∏è‚É£2Ô∏è‚É£ Cluster vs PM2
Cluster	PM2
Node core module Process manager
Manual setup	Automatic
Limited monitoring	Rich monitoring
No auto deploy	Auto restart, logs

üëâ PM2 internally uses cluster mode

1Ô∏è‚É£3Ô∏è‚É£ When to Use Cluster ?

‚úîÔ∏è High - traffic APIs
‚úîÔ∏è CPU has multiple cores
‚úîÔ∏è Stateless services
‚úîÔ∏è Horizontal scaling preparation

1Ô∏è‚É£4Ô∏è‚É£ When NOT to Use Cluster ?

‚ùå CPU - heavy computations
‚ùå Stateful in -memory apps
‚ùå Small applications
‚ùå When using serverless

1Ô∏è‚É£5Ô∏è‚É£ Real - World Use Case

REST APIs

Payment gateways

Chat servers

Microservices

1Ô∏è‚É£6Ô∏è‚É£ Common Interview Q & A
Q1.Does cluster improve performance ?

‚úîÔ∏è Yes(better CPU utilization)

Q2.Can workers share variables ?

‚ùå No

Q3.What happens if a worker crashes ?

‚úîÔ∏è Master can restart it

Q4.Is cluster available in browser ?

‚ùå No(Node.js only)

1Ô∏è‚É£7Ô∏è‚É£ One - Line Interview Summary ‚≠ê

The Cluster module enables Node.js applications to utilize multi - core CPUs by running multiple worker processes that share the same server port.